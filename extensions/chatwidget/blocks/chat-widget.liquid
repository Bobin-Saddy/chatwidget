{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat">
  <div id="launcher-icon-container">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header">
    <div class="header-content">
      <div class="avatar-stack">
        <div class="avatar-status"></div>
        <img id="main-support-avatar" src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      </div>
      <div class="header-text">
        <span id="header-title-text" class="header-title">Live Support</span>
        <span id="header-subtitle-text" class="header-subtitle"><span class="pulse"></span> Online now</span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="tab-home" class="tab-content">
    <div class="home-hero" id="home-hero-bg"> 
      <div class="hero-avatars">
        <img src="https://ui-avatars.com/api/?name=J&background=ddd" class="overlap">
        <img src="https://ui-avatars.com/api/?name=S&background=eee" class="overlap">
        <img src="https://ui-avatars.com/api/?name=M&background=fff" class="overlap">
      </div>
      <h1 id="welcome-h1">Hi there ðŸ‘‹</h1>
      <p id="welcome-p">We are here to help you! Ask us anything.</p>
    </div>
    
    <div class="home-card" id="start-chat-trigger">
      <div class="card-text">
        <strong id="card-msg-text">Send us a message</strong>
        <span id="card-reply-time">Typically replies in 5 minutes</span>
      </div>
      <div class="card-arrow" id="card-arrow-icon">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
    </div>
  </div>

  <div id="tab-chat" class="tab-content" style="display:none;">
    <div id="chat-onboarding-step" class="step-container">
      <div class="welcome-card">
        <h3 id="onboarding-title">Start a conversation</h3>
        <div class="input-group">
          <input id="chat-fname" type="text" placeholder="First Name" />
          <input id="chat-email" type="email" placeholder="Email Address" />
          <button id="chat-submit-info">Continue to Chat</button>
        </div>
      </div>
    </div>

    <div id="chat-chat-step" class="step-container" style="display:none;">
      <div id="chat-messages"></div>
      <div id="chat-footer">
        <div class="input-wrapper">
          <button id="emoji-btn" class="tool-btn">ðŸ˜Š</button>
          <button id="file-btn" class="tool-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
          </button>
          <input id="chat-file-input" type="file" style="display:none;" accept="image/*, .pdf" />
          <input id="chat-input" placeholder="Write a message..." autocomplete="off" />
          <button id="chat-send">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
        <div id="emoji-picker" class="hidden-picker"></div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Messages</span>
    </div>
  </div>
</div>

<style>
:root { 
  --chat-primary: {{ primary_color }}; 
  --chat-font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --chat-base-size: 15px; 
}

#chat-widget * { box-sizing: border-box; font-family: var(--chat-font-family) !important; }

#chat-launcher { 
  position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; 
  border-radius: 50%; color: #fff; display: flex; align-items: center; 
  justify-content: center; cursor: pointer; z-index: 99999; 
  box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  background: var(--chat-primary);
}

#chat-widget { 
  position: fixed; bottom: 100px; right: 25px; width: 370px; height: 620px; 
  max-height: calc(100vh - 130px); background: #ffffff; border-radius: 28px; 
  display: flex; flex-direction: column; overflow: hidden; 
  box-shadow: 0 20px 50px rgba(0,0,0,0.15); z-index: 99998; 
  transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); 
  border: 1px solid rgba(0,0,0,0.08); font-size: var(--chat-base-size);
}

.chat-hidden { opacity: 0; transform: translateY(30px) scale(0.9); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

#chat-header { padding: 24px 20px; color: #fff; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
.header-content { display: flex; align-items: center; gap: 14px; }
.avatar-stack { position: relative; width: 44px; height: 44px; }
.avatar-stack img { width: 100%; height: 100%; border-radius: 12px; object-fit: cover; }
.avatar-status { position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; background: #22c55e; border: 2px solid #fff; border-radius: 50%; }

.tab-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
.home-hero { padding: 40px 25px 60px; border-radius: 0 0 35px 35px; }
.home-hero h1 { font-size: 2.1em; margin: 0 0 10px; font-weight: 700; line-height: 1.1; }

.home-card { background: white; margin: -30px 20px 20px; padding: 20px; border-radius: 18px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 25px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; border: 1px solid #f0f0f0; }
.home-card:hover { transform: translateY(-3px); }

#chat-chat-step { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; display: flex; flex-direction: column; gap: 12px; }

#chat-nav { display: flex; padding: 8px; border-top: 1px solid #f1f5f9; background: #fff; flex-shrink: 0; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; font-size: 11px; color: #94a3b8; }
.nav-item.active { color: var(--chat-primary); }

.hidden-picker { display: none !important; }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://chatwidget-production-0035.up.railway.app"; 

  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const launcherIconContainer = document.getElementById("launcher-icon-container");

  async function fetchAndApplySettings() {
    try {
      const response = await fetch(`${BASE_URL}/api/chat-settings?shop=${shop}`);
      if (!response.ok) return;
      const s = await response.json();
      
      if (s) {
        // 1. UPDATE FONT
        if (s.fontFamily) {
          document.documentElement.style.setProperty('--chat-font-family', s.fontFamily);
          if (!s.fontFamily.includes("system-ui")) {
            const fontLink = document.createElement('link');
            fontLink.rel = 'stylesheet';
            fontLink.href = `https://fonts.googleapis.com/css2?family=${s.fontFamily.split(',')[0].replace(/['"]/g, '').replace(/\s+/g, '+')}:wght@400;700&display=swap`;
            document.head.appendChild(fontLink);
          }
        }
        if (s.baseFontSize) document.documentElement.style.setProperty('--chat-base-size', s.baseFontSize);

        // 2. UPDATE ICON (Fix for Icon not updating)
        if (s.launcherIcon) {
          launcherIconContainer.innerHTML = s.launcherIcon; 
        }

        // 3. COLORS & TEXT
        document.documentElement.style.setProperty('--chat-primary', s.primaryColor);
        document.getElementById("chat-header").style.background = s.headerBgColor;
        document.getElementById("chat-nav").style.background = s.headerBgColor;
        document.getElementById("home-hero-bg").style.background = s.heroBgColor;
        document.getElementById("chat-send").style.background = s.primaryColor;
        document.getElementById("chat-submit-info").style.background = s.primaryColor;

        document.getElementById("header-title-text").innerText = s.headerTitle;
        document.getElementById("welcome-h1").innerText = s.welcomeText;
        document.getElementById("welcome-p").innerText = s.welcomeSubtext;
        document.getElementById("card-msg-text").innerText = s.startConversationText;
        if(s.welcomeImg) document.getElementById("main-support-avatar").src = s.welcomeImg;
      }
    } catch (e) { console.error("Sync failed", e); }
  }

  // Launch Logic
  launcher.addEventListener('click', () => {
    const isVisible = widget.classList.contains("chat-visible");
    widget.className = isVisible ? "chat-hidden" : "chat-visible";
    document.getElementById("launcher-icon-container").style.display = isVisible ? "block" : "none";
    document.getElementById("close-launcher-icon").style.display = isVisible ? "none" : "block";
  });

  // Navigation Logic
  document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', () => {
      document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById(`tab-${item.dataset.tab}`).style.display = 'flex';
      item.classList.add('active');
    });
  });

  document.getElementById('start-chat-trigger').onclick = () => {
    document.querySelector('[data-tab="chat"]').click();
  };

  fetchAndApplySettings();
})();
</script>

{% schema %}
{
  "name": "Live Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}