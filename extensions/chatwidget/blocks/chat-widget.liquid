{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
 <div id="chat-header" style="background: #384959;">
    <div class="header-content">
      <div id="header-avatar-container" class="avatar-stack">
        <div class="avatar-status"></div>
        <img id="main-support-avatar" src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      </div>
      <div class="header-text">
        <span id="header-title-text" class="header-title">Live Support</span>
        <span id="header-subtitle-text" class="header-subtitle"><span class="pulse"></span> Online now</span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="tab-home" class="tab-content">
    <div class="home-hero" id="home-hero-bg" style="background: #bdddfc;"> 
      <div class="hero-avatars">
        <img src="https://ui-avatars.com/api/?name=J&background=ddd" class="overlap">
        <img src="https://ui-avatars.com/api/?name=S&background=eee" class="overlap">
        <img src="https://ui-avatars.com/api/?name=M&background=fff" class="overlap">
      </div>
      <h1 id="welcome-h1">Hi there ðŸ‘‹</h1>
      <p id="welcome-p">We are here to help you! Ask us anything.</p>
    </div>
    
    <div class="home-card" id="start-chat-trigger">
      <div class="card-text">
        <strong id="card-msg-text">Send us a message</strong>
        <span id="card-reply-time">Typically replies in 5 minutes</span>
      </div>
      <div class="card-arrow" id="card-arrow-icon" style="background: {{ primary_color }}22; color: {{ primary_color }};">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
    </div>
  </div>

  <div id="tab-chat" class="tab-content" style="display:none;">
    <div id="chat-onboarding-step" class="step-container">
      <div class="welcome-card">
        <h3 id="onboarding-title">Start a conversation</h3>
        <p id="onboarding-p">Please provide your details.</p>
        <div class="input-group">
          <input id="chat-fname" type="text" placeholder="First Name" />
          <input id="chat-email" type="email" placeholder="Email Address" />
          <button id="chat-submit-info" style="background: #384959;color: #bdddfc;">Continue to Chat</button>
        </div>
      </div>
    </div>

    <div id="chat-chat-step" class="step-container" style="display:none;">
      <div id="chat-messages"></div>
      <div id="chat-footer">
        <div class="input-wrapper">
          <button id="emoji-btn" class="tool-btn">ðŸ˜Š</button>
          
          <button id="file-btn" class="tool-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
          </button>
          <input id="chat-file-input" type="file" style="display:none;" accept="image/*, .pdf, .svg" />

          <input id="chat-input" placeholder="Write a message..." autocomplete="off" />
          <button id="chat-send" style="background: {{ primary_color }};">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
        <div id="emoji-picker" class="hidden-picker"></div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </div>
    <div class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Messages</span>
    </div>
  </div>
</div>

<style>
/* ... (Existing styles maintained) ... */
:root { --chat-primary: {{ primary_color }}; }
#chat-widget * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
#chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 99999; box-shadow: 0 8px 25px rgba(0,0,0,0.2); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
#chat-launcher:hover { transform: scale(1.1) rotate(5deg); }
#chat-widget { position: fixed; bottom: 100px; right: 25px; width: 370px; height: 620px; max-height: calc(100vh - 130px); background: #ffffff; border-radius: 28px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.15); z-index: 99998; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); border: 1px solid rgba(0,0,0,0.08); }
.chat-hidden { opacity: 0; transform: translateY(30px) scale(0.9); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }
#chat-header { padding: 24px 20px; color: #fff; display: flex; justify-content: space-between; align-items: center; position: relative; }
.header-content { display: flex; align-items: center; gap: 14px; }
.avatar-stack { position: relative; width: 44px; height: 44px; }
.avatar-stack img { width: 100%; height: 100%; border-radius: 14px; object-fit: cover; border: 2px solid rgba(255,255,255,0.3); }
.avatar-status { position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background: #22c55e; border: 3px solid #fff; border-radius: 50%; }
.header-title { display: block; font-weight: 700; font-size: 17px; letter-spacing: -0.3px; color: #bdddfc; }
.header-subtitle { font-size: 13px; display: flex; align-items: center; gap: 6px; margin-top: 2px; color: #bdddfc; }
.pulse { width: 8px; height: 8px; background: #4ade80; border-radius: 50%; box-shadow: 0 0 0 rgba(74, 222, 128, 0.4); animation: pulse-anim 2s infinite; }
#chat-close { background: rgba(0,0,0,0.1); border: none; color: #fff; cursor: pointer; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
.tab-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; overflow-x: hidden; }
.home-hero { padding: 45px 25px 70px; color: white; border-radius: 0 0 40px 40px; }
.home-hero h1 { font-size: 32px; margin: 0 0 10px; font-weight: 700; letter-spacing: -1px; color: #384959; }
.home-hero p { font-size: 16px; line-height: 1.5; margin: 0; font-weight: 500; color: #384959; }
.hero-avatars { display: flex; margin-bottom: 20px; }
.hero-avatars img { width: 48px; height: 48px; border-radius: 50%; border: 3px solid var(--chat-primary); margin-right: -15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
.home-card { background: white; margin: -40px 20px 20px; padding: 24px; border-radius: 22px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 15px 35px rgba(0,0,0,0.06); cursor: pointer; border: 3px solid #384959; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
.home-card:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
.card-text strong { display: block; font-size: 17px; color: #384959; margin-bottom: 4px; }
.card-text span { font-size: 14px; color: #384959; font-weight: 500; }
.card-arrow { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
#chat-nav { display: flex; backdrop-filter: blur(10px); border-top: 1px solid #f1f5f9; padding: 12px 10px; background: #384959; }
.nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #94a3b8; cursor: pointer; transition: 0.3s; padding: 8px; border-radius: 12px; }
.nav-item.active { color: var(--chat-primary); background: #bdddfc; }
.nav-item span { font-size: 12px; font-weight: 700; }
.step-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f8fafc; }
#chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
.msg { max-width: 80%; display: flex; flex-direction: column; }
.msg-content { padding: 12px 18px; border-radius: 20px; font-size: 16px; line-height: 1.5; box-shadow: 0 2px 5px rgba(0,0,0,0.02); overflow-wrap: break-word; }

/* IMAGE HANDLING */
.msg-image { max-width: 100%; border-radius: 12px; margin-top: 8px; display: block; border: 1px solid rgba(0,0,0,0.1); cursor: pointer; }
.file-link { font-size: 12px; font-weight: 700; text-decoration: none; margin-top: 5px; display: inline-block; }

.user { align-self: flex-end; }
.user .msg-content { background: var(--chat-primary); color: white; border-bottom-right-radius: 4px; }
.admin { align-self: flex-start; }
.admin .msg-content { background: white; color: #1e293b; border-bottom-left-radius: 4px; border: 1px solid #e2e8f0; }
.msg-meta { font-size: 11px; color: #94a3b8; margin-top: 4px; font-weight: 500; }
#chat-footer { padding: 16px 20px 24px; background: #fff; border-top: 1px solid #f1f5f9; position: relative; }
.input-wrapper { display: flex; align-items: center; background: #f1f5f9; border-radius: 18px; padding: 8px 12px; gap: 10px; border: 2px solid transparent; transition: 0.2s; }
.input-wrapper:focus-within { border-color: var(--chat-primary); background: #fff; box-shadow: 0 0 0 4px {{ primary_color }}15; }
#chat-input { flex: 1; border: none; background: transparent; outline: none; font-size: 15px; color: #1e293b; padding: 8px 0; }
.tool-btn { background: none; border: none; cursor: pointer; font-size: 20px; padding: 0; opacity: 0.7; transition: 0.2s; display: flex; align-items: center; }
#chat-send { color: white; border: none; width: 40px; height: 40px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
.welcome-card { padding: 40px 25px; text-align: center; }
.welcome-card h3 { font-size: 24px; font-weight: 700; margin-bottom: 12px; color: #384959; }
.input-group { display: flex; flex-direction: column; gap: 12px; }
.input-group input { padding: 14px 18px; border: 1px solid #384959; border-radius: 14px; font-size: 15px; outline: none; transition: 0.2s; background: #bdddfc; }
#chat-submit-info { border: none; color: #fff; padding: 16px; border-radius: 14px; font-weight: 700; cursor: pointer; font-size: 16px; transition: 0.3s; margin-top: 10px; }
#emoji-picker { position: absolute; bottom: 90px; left: 20px; right: 20px; background: white; border-radius: 18px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); border: 1px solid #eee; display: grid; grid-template-columns: repeat(5, 1fr); padding: 15px; z-index: 1000; gap: 5px; }
.hidden-picker { display: none !important; }
@keyframes pulse-anim { 0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); } 100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); } }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://chatwidget-production-0035.up.railway.app"; 

  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const navItems = document.querySelectorAll('.nav-item');
  const tabs = { home: document.getElementById('tab-home'), chat: document.getElementById('tab-chat') };
  const onboardingStep = document.getElementById("chat-onboarding-step");
  const chatStep = document.getElementById("chat-chat-step");
  const msgBox = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");
  const fileInput = document.getElementById("chat-file-input");

async function fetchAndApplySettings() {
  try {
    const response = await fetch(`${BASE_URL}/api/chat-settings?shop=${shop}`);
    if (!response.ok) return;
    const s = await response.json();
    if (s) {
      // 1. BACKGROUND COLORS
      launcher.style.background = s.primaryColor;
      document.getElementById("chat-header").style.background = s.headerBgColor;
      document.getElementById("home-hero-bg").style.background = s.heroBgColor;
      document.getElementById("chat-nav").style.background = s.headerBgColor; // Matches nav to header
      
      // 2. TEXT COLORS (The missing part)
      // Header Text
      document.getElementById("header-title-text").style.color = s.headerTextColor;
      document.getElementById("header-subtitle-text").style.color = s.headerTextColor;
      
      // Hero/Banner Text
      document.getElementById("welcome-h1").style.color = s.heroTextColor;
      document.getElementById("welcome-p").style.color = s.heroTextColor;
      
      // Card Text (optional, usually looks best matching header or hero)
      document.getElementById("card-msg-text").style.color = s.headerBgColor;
      
      // 3. ICON UPDATE
      const iconContainer = document.getElementById("launcher-icon");
      const iconPaths = {
        bubble: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`,
        support: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>`,
        sparkle: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path></svg>`,
        send: `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"></path><path d="M22 2 11 13"></path></svg>`
      };
      
      if(s.launcherIcon && iconPaths[s.launcherIcon]) {
        iconContainer.innerHTML = iconPaths[s.launcherIcon];
      }
      
      // 4. CONTENT UPDATES
      document.getElementById("header-title-text").innerText = s.headerTitle;
      document.getElementById("header-subtitle-text").innerHTML = `<span class="pulse"></span> ${s.headerSubtitle}`;
      document.getElementById("card-msg-text").innerText = s.startConversationText || "Send us a message";
      document.getElementById("card-reply-time").innerText = s.replyTimeText;
      document.getElementById("welcome-h1").innerText = s.welcomeText;
      document.getElementById("welcome-p").innerText = s.welcomeSubtext;

      // Update CSS Variables for dynamic elements (like user message bubbles)
      document.documentElement.style.setProperty('--chat-primary', s.primaryColor);

    }
  } catch (e) { console.error("Failed to load settings", e); }
}
  fetchAndApplySettings();

  function switchTab(tabId) {
    Object.values(tabs).forEach(t => t.style.display = 'none');
    navItems.forEach(n => n.classList.remove('active'));
    tabs[tabId].style.display = 'flex';
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
  }

  navItems.forEach(item => item.addEventListener('click', () => switchTab(item.dataset.tab)));
  document.getElementById('start-chat-trigger').addEventListener('click', () => {
    switchTab('chat');
    loadMessages();
  });

  launcher.addEventListener('click', () => {
    const isVisible = widget.classList.contains("chat-visible");
    widget.classList.toggle("chat-visible", !isVisible);
    widget.classList.toggle("chat-hidden", isVisible);
    document.getElementById("launcher-icon").style.display = isVisible ? "block" : "none";
    document.getElementById("close-launcher-icon").style.display = isVisible ? "none" : "block";
  });
  
  document.getElementById("chat-close").onclick = () => launcher.click();

  const addMessageToUI = (m) => {
    const div = document.createElement("div");
    div.className = `msg ${m.sender}`;
    
    // Check if message contains an image/svg
    const isImg = m.fileUrl && m.fileUrl.match(/\.(jpeg|jpg|gif|png|svg)$/) != null || (m.fileUrl && m.fileUrl.startsWith('data:image'));
    
    let contentHtml = `<div class="msg-content">${m.message}</div>`;
    
    if(m.fileUrl) {
      if(isImg) {
        contentHtml = `
          <div class="msg-content">
            ${m.message}
            <img src="${m.fileUrl}" class="msg-image" onclick="window.open('${m.fileUrl}')" />
          </div>`;
      } else {
        contentHtml = `
          <div class="msg-content">
            ${m.message}
            <a href="${m.fileUrl}" target="_blank" class="file-link" style="color: ${m.sender === 'user' ? '#fff' : 'var(--chat-primary)'}">ðŸ“Ž View Attachment</a>
          </div>`;
      }
    }

    div.innerHTML = `${contentHtml}<div class="msg-meta">${new Date(m.createdAt || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>`;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  async function loadMessages() {
    const sessionId = localStorage.getItem("chat_session");
    if (!sessionId) return;
    try {
      const res = await fetch(`${BASE_URL}/app/chat/messages?shop=${shop}&sessionId=${sessionId}`);
      if (res.ok) {
        const data = await res.json();
        const currentMsgCount = msgBox.querySelectorAll('.msg').length;
        if (data.length > currentMsgCount) {
          msgBox.innerHTML = ''; 
          data.forEach(addMessageToUI);
          msgBox.scrollTo({ top: msgBox.scrollHeight, behavior: 'smooth' });
        }
      }
    } catch (e) { console.error("Sync error"); }
  }

  document.getElementById("chat-submit-info").onclick = async () => {
    const fname = document.getElementById("chat-fname").value.trim();
    const email = document.getElementById("chat-email").value.trim();
    if(!fname || !email) return alert("Please fill details");
    const sessionId = "sess_" + Date.now();
    try {
      const res = await fetch(`${BASE_URL}/app/chat/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ shop, fname, email, sessionId })
      });
      if (res.ok) {
        localStorage.setItem("chat_session", sessionId);
        localStorage.setItem("chat_user_email", email);
        onboardingStep.style.display = "none";
        chatStep.style.display = "flex";
        loadMessages();
      }
    } catch (e) { console.error("Reg error"); }
  };

  // --- FILE HANDLING LOGIC ---
  document.getElementById("file-btn").onclick = () => fileInput.click();

  fileInput.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      const base64 = event.target.result;
      handleSend(`Sent an attachment: ${file.name}`, base64);
    };
    reader.readAsDataURL(file);
    fileInput.value = ""; // Clear for next selection
  };

  async function handleSend(customText, fileUrl = null) {
    const text = customText || chatInput.value.trim();
    const sId = localStorage.getItem("chat_session");
    const email = localStorage.getItem("chat_user_email");
    if (!text || !sId) return;

    addMessageToUI({ sender: 'user', message: text, fileUrl: fileUrl });
    chatInput.value = "";

    try {
      await fetch(`${BASE_URL}/app/chat/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          sessionId: sId, 
          message: text, 
          shop: shop, 
          email: email,
          fileUrl: fileUrl 
        })
      });
    } catch (e) { console.error("Send error"); }
  }

  document.getElementById("chat-send").onclick = () => handleSend();
  chatInput.onkeydown = (e) => { if (e.key === "Enter") handleSend(); };

  // Emoji Picker Logic
  const picker = document.getElementById("emoji-picker");
  const emojis = ["ðŸ˜Š","ðŸ‘‹","ðŸ™Œ","ðŸ”¥","âœ…","ðŸ¤”","ðŸ’¡","ðŸš€","â¤ï¸","âœ¨"];
  picker.innerHTML = emojis.map(e => `<span style="cursor:pointer; font-size: 22px; text-align:center;">${e}</span>`).join("");
  document.getElementById("emoji-btn").onclick = () => picker.classList.toggle("hidden-picker");
  picker.onclick = (e) => {
    if(e.target.tagName === 'SPAN') {
      chatInput.value += e.target.innerText;
      picker.classList.add("hidden-picker");
      chatInput.focus();
    }
  };

  if (localStorage.getItem("chat_session")) {
    onboardingStep.style.display = "none";
    chatStep.style.display = "flex";
    loadMessages();
    setInterval(loadMessages, 5000);
  }
})();
</script>

{% schema %}
{
  "name": "Live Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}