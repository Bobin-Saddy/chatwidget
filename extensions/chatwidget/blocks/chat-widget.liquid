{%- assign primary_color = section.settings.primary_color -%}

<div id="chat-launcher" style="background: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header" style="background: {{ primary_color }};">
    <div class="header-content">
      <img src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      <div class="header-text">
        <span class="header-title">{{ section.settings.header_title }}</span>
        <span class="header-subtitle"><span class="pulse"></span> Online now</span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="chat-onboarding-step" class="step-container">
    <div class="welcome-card">
      <div class="welcome-emoji">âœ¨</div>
      <h3>Welcome!</h3>
      <div class="input-group">
        <input id="chat-fname" type="text" placeholder="First Name" />
        <input id="chat-email" type="email" placeholder="Email Address" />
        <button id="chat-submit-info" style="background: {{ primary_color }};">Start Chat</button>
      </div>
    </div>
  </div>

  <div id="chat-chat-step" class="step-container" style="display:none;">
    <div id="chat-messages"></div>
    <div id="chat-footer">
      <div id="emoji-picker-container" class="hidden-picker">
        <div class="picker-header"><span>Emojis</span><button id="close-emoji-picker">&times;</button></div>
        <div id="emoji-grid"></div>
      </div>
      <div class="input-wrapper">
        <button id="emoji-btn" type="button" class="tool-btn">ðŸ˜Š</button>
        <input id="chat-input" placeholder="Type a message..." autocomplete="off" />
        <button id="chat-send" style="background: {{ primary_color }};">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<style>
/* ... (Keep your existing CSS but ensure z-index is high) ... */
#chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 999999; }
#chat-widget { position: fixed; bottom: 100px; right: 25px; width: 350px; height: 500px; background: #fff; border-radius: 15px; display: flex; flex-direction: column; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 999999; overflow: hidden; }
.chat-hidden { display: none !important; }
.step-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#chat-messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #f8f9fa; }
.msg { padding: 8px 12px; border-radius: 10px; font-size: 14px; max-width: 80%; }
.msg.user { align-self: flex-end; background: {{ primary_color }}; color: #fff; }
.msg.admin { align-self: flex-start; background: #e9ecef; color: #000; }
#chat-input { flex: 1; border: none; outline: none; background: transparent; padding: 10px; }
.hidden-picker { display: none !important; }
/* ... rest of CSS ... */
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  // CRITICAL: No trailing slash here
  const BASE_URL = "https://chatwidget-production-0035.up.railway.app"; 

  const getUrl = (path) => `${BASE_URL}/${path}`;

  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const chatInput = document.getElementById("chat-input");
  const msgBox = document.getElementById("chat-messages");

  launcher.onclick = () => {
    widget.classList.toggle("chat-hidden");
    document.getElementById("launcher-icon").style.display = widget.classList.contains("chat-hidden") ? "block" : "none";
    document.getElementById("close-launcher-icon").style.display = widget.classList.contains("chat-hidden") ? "none" : "block";
  };

  const addMessageUI = (m) => {
    const d = document.createElement("div");
    d.className = `msg ${m.sender}`;
    d.innerText = m.message;
    msgBox.appendChild(d);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  const loadMessages = async () => {
    const sId = localStorage.getItem("chat_session");
    if(!sId) return;
    try {
      const res = await fetch(getUrl(`app/chat/messages?shop=${shop}&sessionId=${sId}`));
      const data = await res.json();
      msgBox.innerHTML = "";
      data.forEach(addMessageUI);
    } catch(e) { console.error(e); }
  };

  document.getElementById("chat-submit-info").onclick = async () => {
    const fname = document.getElementById("chat-fname").value;
    const email = document.getElementById("chat-email").value;
    const sId = Date.now().toString();
    localStorage.setItem("chat_user_email", email);
    localStorage.setItem("chat_session", sId);

    await fetch(getUrl("app/chat/register"), {
      method: "POST",
      body: JSON.stringify({ shop, fname, email, sessionId: sId })
    });
    
    document.getElementById("chat-onboarding-step").style.display = "none";
    document.getElementById("chat-chat-step").style.display = "flex";
    loadMessages();
  };

  document.getElementById("chat-send").onclick = async () => {
    const msg = chatInput.value;
    if(!msg) return;
    const sId = localStorage.getItem("chat_session");
    addMessageUI({ sender: 'user', message: msg });
    chatInput.value = "";
    
    await fetch(getUrl("app/chat/message"), {
      method: "POST",
      body: JSON.stringify({ shop, sessionId: sId, message: msg })
    });
  };

  if(localStorage.getItem("chat_user_email")) {
    document.getElementById("chat-onboarding-step").style.display = "none";
    document.getElementById("chat-chat-step").style.display = "flex";
    loadMessages();
    setInterval(loadMessages, 5000);
  }
})();
</script>

{% schema %}
{
  "name": "Railway Chat Widget",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Theme Color", "default": "#6366f1" },
    { "type": "text", "id": "header_title", "label": "Header Title", "default": "Live Support" }
  ]
}
{% endschema %}