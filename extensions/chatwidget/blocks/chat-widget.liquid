{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header" style="background: {{ primary_color }};">
    <div class="header-content">
      <div id="header-avatar-container" class="avatar-stack">
        <div class="avatar-status" style="border-color: {{ primary_color }};"></div>
        <img src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      </div>
      <div class="header-text">
        <span id="header-title-text" class="header-title">Live Support</span>
        <span class="header-subtitle"><span class="pulse"></span> Online now</span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="tab-home" class="tab-content">
    <div class="home-hero" style="background: {{ primary_color }};">
      <div class="hero-avatars">
        <img src="https://ui-avatars.com/api/?name=J&background=ddd" class="overlap">
        <img src="https://ui-avatars.com/api/?name=S&background=eee" class="overlap">
        <img src="https://ui-avatars.com/api/?name=M&background=fff" class="overlap">
      </div>
      <h1>Hi there ðŸ‘‹</h1>
      <p>We are here to help you!</p>
    </div>
    <div class="home-card" id="start-chat-trigger">
      <div class="card-text">
        <strong>Send us a message</strong>
        <span>We reply in under 5 minutes</span>
      </div>
      <div class="card-arrow" style="background: {{ primary_color }}22; color: {{ primary_color }};">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
      </div>
    </div>
  </div>

  <div id="tab-chat" class="tab-content" style="display:none;">
    <div id="chat-onboarding-step" class="step-container">
      <div class="welcome-card">
        <h3>Start a conversation</h3>
        <div class="input-group">
          <input id="chat-fname" type="text" placeholder="First Name" />
          <input id="chat-email" type="email" placeholder="Email Address" />
          <button id="chat-submit-info" style="background: {{ primary_color }};">Continue to Chat</button>
        </div>
      </div>
    </div>

    <div id="chat-chat-step" class="step-container" style="display:none;">
      <div id="chat-messages"></div>
      <div id="chat-footer">
        <div class="input-wrapper">
          <input id="chat-input" placeholder="Write a message..." autocomplete="off" />
          <button id="chat-send" style="background: {{ primary_color }};">
             <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <div class="nav-item active" data-tab="home"><span>Home</span></div>
    <div class="nav-item" data-tab="chat"><span>Messages</span></div>
  </div>
</div>

<style>
/* ... (Style same as before, keeping it short for brevity) ... */
#chat-widget * { box-sizing: border-box; font-family: sans-serif; }
#chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 99999; box-shadow: 0 8px 25px rgba(0,0,0,0.2); }
#chat-widget { position: fixed; bottom: 100px; right: 25px; width: 370px; height: 600px; background: #fff; border-radius: 28px; display: flex; flex-direction: column; overflow: hidden; z-index: 99998; border: 1px solid #eee; transition: 0.3s; }
.chat-hidden { opacity: 0; transform: translateY(20px); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0); pointer-events: all; }
#chat-header { padding: 20px; color: #fff; display: flex; justify-content: space-between; }
.tab-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; }
#chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: #f8fafc; }
.msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 14px; }
.user { align-self: flex-end; background: {{ primary_color }}; color: white; }
.admin { align-self: flex-start; background: #e2e8f0; color: #1e293b; }
#chat-footer { padding: 15px; border-top: 1px solid #eee; }
.input-wrapper { display: flex; background: #f1f5f9; padding: 5px 15px; border-radius: 20px; }
#chat-input { flex: 1; border: none; background: transparent; outline: none; padding: 10px 0; }
#chat-send { border: none; color: white; border-radius: 10px; cursor: pointer; padding: 5px 10px; }
#chat-nav { display: flex; border-top: 1px solid #eee; padding: 10px; background: #fff; }
.nav-item { flex: 1; text-align: center; cursor: pointer; color: #94a3b8; font-weight: bold; font-size: 12px; }
.nav-item.active { color: {{ primary_color }}; }
.input-group { display: flex; flex-direction: column; gap: 10px; padding: 20px; }
.input-group input { padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
.home-hero { padding: 40px 20px; color: white; }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://chatwidget-production-0035.up.railway.app"; 

  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const msgBox = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");

  // Helper to add message to UI
  const addMessageToUI = (m) => {
    const div = document.createElement("div");
    div.className = `msg ${m.sender}`;
    div.innerText = m.message;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  // 1. Toggle Widget
  launcher.onclick = () => {
    const isVisible = widget.classList.contains("chat-visible");
    widget.classList.toggle("chat-visible", !isVisible);
    widget.classList.toggle("chat-hidden", isVisible);
  };

  // 2. Tab Navigation
  document.querySelectorAll('.nav-item').forEach(item => {
    item.onclick = () => {
      const tab = item.dataset.tab;
      document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      document.getElementById('tab-home').style.display = tab === 'home' ? 'flex' : 'none';
      document.getElementById('tab-chat').style.display = tab === 'chat' ? 'flex' : 'none';
    };
  });
  document.getElementById('start-chat-trigger').onclick = () => document.querySelector('[data-tab="chat"]').click();

  // 3. Load Messages
  async function loadMessages() {
    const sessionId = localStorage.getItem("chat_session");
    if (!sessionId) return;
    try {
      const res = await fetch(`${BASE_URL}/app/chat/messages?sessionId=${sessionId}`);
      const data = await res.json();
      if (Array.isArray(data)) {
        msgBox.innerHTML = ''; 
        data.forEach(addMessageToUI);
      }
    } catch (e) { console.error("Sync error"); }
  }

  // 4. Register
  document.getElementById("chat-submit-info").onclick = async () => {
    const fname = document.getElementById("chat-fname").value.trim();
    const email = document.getElementById("chat-email").value.trim();
    if (!fname || !email) return alert("Fill details");

    const sessionId = "sess_" + Date.now();
    localStorage.setItem("chat_session", sessionId);
    localStorage.setItem("chat_user_email", email);

    await fetch(`${BASE_URL}/app/chat/register`, {
      method: "POST",
      body: JSON.stringify({ shop, fname, email, sessionId })
    });

    document.getElementById("chat-onboarding-step").style.display = "none";
    document.getElementById("chat-chat-step").style.display = "flex";
  };

  // 5. Send Message (FIXED)
  async function handleSend() {
    const text = chatInput.value.trim();
    if (!text) return;
    
    const sessionId = localStorage.getItem("chat_session");
    
    // UI mein turant dikhane ke liye
    addMessageToUI({ sender: 'user', message: text });
    chatInput.value = "";

    try {
      await fetch(`${BASE_URL}/app/chat/message`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ sessionId, message: text, shop })
      });
    } catch (e) { console.error("Send failed"); }
  }

  document.getElementById("chat-send").onclick = handleSend;
  chatInput.onkeydown = (e) => { if(e.key === "Enter") handleSend(); };

  // Init
  if (localStorage.getItem("chat_session")) {
    document.getElementById("chat-onboarding-step").style.display = "none";
    document.getElementById("chat-chat-step").style.display = "flex";
    loadMessages();
    setInterval(loadMessages, 5000);
  }
})();
</script>

{% schema %}
{
  "name": "Live Chat Premium",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Brand Color", "default": "#6366f1" }
  ]
}
{% endschema %}