{%- assign primary_color = section.settings.primary_color | default: '#6366f1' -%}

<div id="chat-launcher" aria-label="Open Chat" style="background: {{ primary_color }};">
  <div id="launcher-icon">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
  </div>
  <div id="close-launcher-icon" style="display:none;">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
  </div>
</div>

<div id="chat-widget" class="chat-hidden">
  <div id="chat-header" style="background: {{ primary_color }};">
    <div class="header-content">
      <div id="header-avatar-container" class="avatar-stack" style="display:none;">
        <div class="avatar-status" style="border-color: {{ primary_color }};"></div>
        <img src="https://ui-avatars.com/api/?name=Support&background=fff&color={{ primary_color | remove: '#' }}" alt="Support">
      </div>
      <div class="header-text">
        <span id="header-title-text" class="header-title">Live Support</span>
        <span class="header-subtitle"><span class="pulse"></span> Online now</span>
      </div>
    </div>
    <button id="chat-close" title="Minimize">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
    </button>
  </div>

  <div id="tab-home" class="tab-content">
    <div class="home-hero" style="background: {{ primary_color }};">
      <div class="hero-avatars">
        <img src="https://ui-avatars.com/api/?name=1&background=ddd" class="overlap">
        <img src="https://ui-avatars.com/api/?name=2&background=eee" class="overlap">
        <img src="https://ui-avatars.com/api/?name=3&background=fff" class="overlap">
      </div>
      <h1>Hi there ðŸ‘‹</h1>
      <p>Welcome to our website. Ask us anything ðŸŽ‰</p>
    </div>
    
    <div class="home-card" id="start-chat-trigger">
      <div class="card-text">
        <strong>Chat with us</strong>
        <span>We typically reply within a few minutes.</span>
      </div>
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="{{ primary_color }}" stroke-width="2.5"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
    </div>
  </div>

  <div id="tab-chat" class="tab-content" style="display:none;">
    <div id="chat-onboarding-step" class="step-container">
      <div class="welcome-card">
        <div class="welcome-emoji">âœ¨</div>
        <h3>Welcome!</h3>
        <p>Please enter your details to start the chat.</p>
        <div class="input-group">
          <div class="name-row">
            <input id="chat-fname" type="text" placeholder="First Name" />
            <input id="chat-lname" type="text" placeholder="Last Name" />
          </div>
          <input id="chat-email" type="email" placeholder="Email Address" />
          <button id="chat-submit-info" style="background: {{ primary_color }};">
            Let's Start Chat
          </button>
        </div>
      </div>
    </div>

    <div id="chat-chat-step" class="step-container" style="display:none;">
      <div id="chat-messages"></div>
      <div id="chat-footer">
        <div class="input-wrapper">
          <button id="emoji-btn" class="tool-btn">ðŸ˜Š</button>
          <input id="chat-input" placeholder="Type a message..." autocomplete="off" />
          <button id="chat-send" style="background: {{ primary_color }};">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
          </button>
        </div>
        <div id="emoji-picker" class="hidden-picker"></div>
      </div>
    </div>
  </div>

  <div id="chat-nav">
    <button class="nav-item active" data-tab="home">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
      <span>Home</span>
    </button>
    <button class="nav-item" data-tab="chat">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
      <span>Chat</span>
    </button>
  </div>
</div>

<style>
:root {
  --chat-primary: {{ primary_color }};
  --chat-bg: #ffffff;
  --chat-text-main: #1f2937;
  --chat-text-muted: #6b7280;
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

/* Base Widget & Launcher */
#chat-launcher { position: fixed; bottom: 25px; right: 25px; width: 64px; height: 64px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10000; box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1); transition: transform 0.3s; }
#chat-widget { position: fixed; bottom: 105px; right: 25px; width: 380px; height: 600px; max-height: calc(100vh - 140px); background: var(--chat-bg); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; box-shadow: var(--shadow-xl); z-index: 9999; transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); border: 1px solid rgba(0,0,0,0.05); }
.chat-hidden { opacity: 0; transform: translateY(20px) scale(0.95); pointer-events: none; }
.chat-visible { opacity: 1; transform: translateY(0) scale(1); pointer-events: all; }

/* Header */
#chat-header { padding: 20px; color: #fff; display: flex; justify-content: space-between; align-items: center; }
.header-content { display: flex; align-items: center; gap: 12px; }
.avatar-stack img { width: 40px; height: 40px; border-radius: 12px; background: #fff; }
.avatar-status { position: absolute; bottom: 18px; left: 50px; width: 12px; height: 12px; background: #22c55e; border: 2px solid white; border-radius: 50%; z-index: 2; }
.header-title { display: block; font-weight: 700; font-size: 16px; }
.header-subtitle { font-size: 12px; opacity: 0.9; display: flex; align-items: center; gap: 4px; }
.pulse { width: 6px; height: 6px; background: #4ade80; border-radius: 50%; animation: pulse-anim 2s infinite; }
#chat-close { background: none; border: none; color: #fff; cursor: pointer; opacity: 0.7; }

/* Tab Container */
.tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

/* Home Tab Styles */
.home-hero { padding: 40px 30px 60px; color: white; }
.home-hero h1 { font-size: 28px; margin: 15px 0 8px; font-weight: 800; }
.home-hero p { font-size: 15px; opacity: 0.9; line-height: 1.4; }
.hero-avatars { display: flex; margin-bottom: 5px; }
.hero-avatars img { width: 42px; height: 42px; border-radius: 50%; border: 3px solid var(--chat-primary); margin-right: -12px; }
.home-card { background: white; margin: -35px 20px 20px; padding: 20px; border-radius: 18px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 10px 20px rgba(0,0,0,0.05); cursor: pointer; border: 1px solid #f3f4f6; transition: 0.2s; }
.home-card:hover { transform: translateY(-2px); }
.card-text strong { display: block; font-size: 16px; color: #111; margin-bottom: 2px; }
.card-text span { font-size: 13px; color: #6b7280; }

/* Navigation */
#chat-nav { display: flex; background: white; border-top: 1px solid #f3f4f6; padding: 10px 0; border-radius: 0 0 24px 24px; }
.nav-item { flex: 1; background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 4px; color: #9ca3af; cursor: pointer; }
.nav-item.active { color: var(--chat-primary); }
.nav-item span { font-size: 11px; font-weight: 600; }

/* Chat step styles */
.step-container { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
#chat-messages { flex: 1; overflow-y: auto; padding: 20px; background: #fafafa; display: flex; flex-direction: column; gap: 15px; }
.msg-content { padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.5; }
.user .msg-content { background: var(--chat-primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
.admin .msg-content { background: white; color: var(--chat-text-main); align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #eee; }
.msg { max-width: 85%; display: flex; flex-direction: column; }
.user { align-self: flex-end; }
.admin { align-self: flex-start; }
.msg-meta { font-size: 10px; color: var(--chat-text-muted); margin-top: 4px; }

/* Footer & Inputs */
#chat-footer { padding: 15px 20px 20px; background: #fff; border-top: 1px solid #f3f4f6; position: relative; }
.input-wrapper { display: flex; align-items: center; background: #f3f4f6; border-radius: 16px; padding: 6px 10px; gap: 8px; }
#chat-input { flex: 1; border: none; background: transparent; outline: none; font-size: 14px; padding: 8px 0; }
.tool-btn { background: none; border: none; cursor: pointer; font-size: 18px; opacity: 0.6; }
#chat-send { color: white; border: none; width: 36px; height: 36px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
.input-group { display: flex; flex-direction: column; gap: 12px; margin-top: 15px; }
.name-row { display: flex; gap: 10px; }
.input-group input { padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 14px; width: 100%; outline: none; }
#emoji-picker { position: absolute; bottom: 80px; left: 20px; right: 20px; background: white; border-radius: 12px; box-shadow: var(--shadow-xl); border: 1px solid #eee; display: grid; grid-template-columns: repeat(5, 1fr); padding: 10px; z-index: 100; }
.hidden-picker { display: none !important; }

@keyframes pulse-anim { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
</style>

<script>
(() => {
  const shop = "{{ shop.permanent_domain }}";
  const BASE_URL = "https://chatwidget-production-0035.up.railway.app"; 

  const widget = document.getElementById("chat-widget");
  const launcher = document.getElementById("chat-launcher");
  const navItems = document.querySelectorAll('.nav-item');
  const tabs = { home: document.getElementById('tab-home'), chat: document.getElementById('tab-chat') };
  
  const onboardingStep = document.getElementById("chat-onboarding-step");
  const chatStep = document.getElementById("chat-chat-step");
  const msgBox = document.getElementById("chat-messages");
  const chatInput = document.getElementById("chat-input");

  const getUrl = (path) => `${BASE_URL}/${path.replace(/^\//, '')}`;

  // Tab Switching Logic
  function switchTab(tabId) {
    Object.values(tabs).forEach(t => t.style.display = 'none');
    navItems.forEach(n => n.classList.remove('active'));
    
    tabs[tabId].style.display = 'flex';
    document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
    
    // UI Tweaks per tab
    document.getElementById('header-avatar-container').style.display = tabId === 'chat' ? 'flex' : 'none';
    document.getElementById('header-title-text').innerText = tabId === 'chat' ? 'Inbox' : 'Live Support';
  }

  navItems.forEach(item => item.onclick = () => switchTab(item.dataset.tab));
  document.getElementById('start-chat-trigger').onclick = () => switchTab('chat');

  // Widget Toggle
  launcher.onclick = () => {
    const isVisible = widget.classList.contains("chat-visible");
    widget.classList.toggle("chat-visible", !isVisible);
    widget.classList.toggle("chat-hidden", isVisible);
    document.getElementById("launcher-icon").style.display = isVisible ? "block" : "none";
    document.getElementById("close-launcher-icon").style.display = isVisible ? "none" : "block";
  };
  document.getElementById("chat-close").onclick = () => launcher.click();

  const addMessageToUI = (m) => {
    const div = document.createElement("div");
    div.className = `msg ${m.sender}`;
    div.innerHTML = `
      <div class="msg-content">${m.message}</div>
      <div class="msg-meta">${new Date(m.createdAt || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
    `;
    msgBox.appendChild(div);
    msgBox.scrollTop = msgBox.scrollHeight;
  };

  async function loadMessages() {
    const sessionId = localStorage.getItem("chat_session");
    if (!sessionId) return;
    try {
      // NOTE: Using chatSessionId as per your Prisma error logs
      const res = await fetch(getUrl(`app/chat/messages?shop=${shop}&sessionId=${sessionId}`));
      if (!res.ok) throw new Error('Sync failed');
      const data = await res.json();
      msgBox.innerHTML = ''; 
      data.forEach(addMessageToUI);
    } catch (e) { console.error("Sync error", e); }
  }

  document.getElementById("chat-submit-info").onclick = async () => {
    const fname = document.getElementById("chat-fname").value.trim();
    const email = document.getElementById("chat-email").value.trim();
    if (!fname || !email) return alert("Please fill details");

    const sessionId = "sess_" + Date.now();
    localStorage.setItem("chat_user_email", email);
    localStorage.setItem("chat_session", sessionId);

    await fetch(getUrl("app/chat/register"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shop, fname, email, sessionId })
    });

    onboardingStep.style.display = "none";
    chatStep.style.display = "flex";
    loadMessages();
  };

  async function handleSend() {
    const text = chatInput.value.trim();
    if (!text) return;
    const sessionId = localStorage.getItem("chat_session");
    const email = localStorage.getItem("chat_user_email");
    
    chatInput.value = "";
    addMessageToUI({ sender: 'user', message: text });

    await fetch(getUrl("app/chat/message"), {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shop, sessionId, message: text, email })
    });
  }

  document.getElementById("chat-send").onclick = handleSend;
  chatInput.onkeypress = (e) => e.key === "Enter" && handleSend();

  // Emoji Picker Logic
  const picker = document.getElementById("emoji-picker");
  const emojis = ["ðŸ˜Š","ðŸ‘‹","ðŸ™Œ","ðŸ”¥","âœ…","ðŸ¤”","ðŸ’¡","ðŸš€","â¤ï¸","âœ¨"];
  picker.innerHTML = emojis.map(e => `<span style="cursor:pointer; text-align:center; padding:5px;">${e}</span>`).join("");
  document.getElementById("emoji-btn").onclick = () => picker.classList.toggle("hidden-picker");
  picker.onclick = (e) => {
    if(e.target.tagName === 'SPAN') {
      chatInput.value += e.target.innerText;
      picker.classList.add("hidden-picker");
      chatInput.focus();
    }
  };

  // Check login state
  if (localStorage.getItem("chat_user_email")) {
    onboardingStep.style.display = "none";
    chatStep.style.display = "flex";
    loadMessages();
    setInterval(loadMessages, 5000);
  }
})();
</script>

{% schema %}
{
  "name": "Live Chat Widget",
  "target": "section",
  "settings": [
    { "type": "color", "id": "primary_color", "label": "Theme Color", "default": "#6366f1" }
  ]
}
{% endschema %}